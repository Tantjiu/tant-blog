# 二、线程安全性

- 要编写线程安全的代码，核心就是对于状态访问操作的管理，特别是对**共享的**和 **可变的**的状态访问

## 2.1 什么是线程安全性

- 多个线程访问同一个类时，这个类始终能表现出正确的行为
- 无状态对象一定是线程安全的
  - 无状态：不能储存数据
  - 有状态：可以储存数据

## 2.2 原子性

- 竞态条件：由于不恰当的执行时序而出现不正确的结果的情况

# 三、对象的共享

## 3.1 可见性

- 同步代码块不仅能够实现原子性，还能保证内存可见性，即某个共享对象的状态改变了，其他线程能直接看到改变后的值

### 3.1.1 非原子的64位操作

- 当线程没有同步的情况下，读取变量，可能会得到一个失效值，但这个值是由之前某个线程设置的值，而不是一个随机值，这种安全性被称之为：最低安全性（牺牲准确度，换取性能的提升）
- Java内存模型要求，变量的读取操作和写入操作都必须是原子操作，但对于非 volatile类型的long和double变量，jvm允许将64位的读操作或者写操作分解成两个32位的操作、如果对该变量的读操作和写操作，可能会读到某个值的高32位和另一个值得低32位（编写Java虚拟机规范时，很多平台还不支持64位原子操作），所以不考虑失效数据问题，在多线程程序中使用共享且可变的long和double类型的变量是不安全的，除非使用 volatile声明，或者用锁保护

### 3.1.2 加锁与可见性

- 加锁的含义不仅仅局限于互斥行为，还包括内存可见性。所以为了保证所有线程都能看到共享变量的最新值，所有执行读或者写操作的线程都必须在同一个锁上同步